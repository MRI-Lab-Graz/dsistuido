#!/bin/bash
# Summary of Pipeline Enhancements - February 2, 2026

cat << 'EOF'

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                    âœ“ PIPELINE ENHANCEMENTS COMPLETE                       â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

## CHANGES IMPLEMENTED

### 1. PROGRESS TRACKING & LIVE COUNTER
   âœ“ Real-time progress bar during processing
   âœ“ File count display: Current/Total
   âœ“ Live statistics: Processed, Skipped, Validated counts
   âœ“ Updates before each file and at completion

   Output format:
   â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
   â•‘ ğŸ“Š PIPELINE PROGRESS                                         â•‘
   â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
   â•‘ Progress: [â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘] 25.0% (105/420)
   â•‘ âœ“ Processed: 105  | âœ— Skipped: 45
   â•‘ âœ“ SRC OK: 105  | âœ“ FIB OK: 103
   â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

### 2. FIB FILE VALIDATION (validate_fib_file method)
   Checks after EVERY FIB generation:
   
   âœ“ File exists on disk
   âœ“ File size > 1 MB (detects empty/incomplete files)
   âœ“ File structure integrity (scipy.io.loadmat)
   âœ“ Presence of expected diffusion metrics
   âœ“ Metric count reported in log
   
   Example validation output:
   âœ“ FIB validated: sub-1293171_ses-3.odf.gqi.fz (62.45 MB, metrics: 8)
   
   Or on failure:
   âœ— FIB validation failed: sub-1293175_ses-1.odf.gqi.fz
     â†’ File is suspiciously small (0.45 MB), may be corrupt

### 3. SRC FILE VALIDATION
   Checks after SRC generation:
   
   âœ“ File exists on disk
   âœ“ File size validation
   âœ“ Reported in log with file size
   
   Example output:
   âœ“ SRC validated: sub-1293171_ses-3.src.gz.sz (245.3 MB)

### 4. COMPREHENSIVE FINAL SUMMARY
   At pipeline completion, displays:
   
   â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
   â•‘ âœ“ PIPELINE COMPLETE                                          â•‘
   â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
   â•‘ Total DWI files found:    411
   â•‘ Successfully processed:   285
   â•‘ SRC files validated:      285
   â•‘ FIB files validated:      283
   â•‘ Skipped (existing):        45
   â•‘ Skipped (other reasons):   81
   â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

### 5. ENHANCED STATISTICS TRACKING
   Added counters for:
   - Total files found vs processed
   - Validation successes (src_ok, fib_ok)
   - Different skip reasons
   - Ratio of successful validation

### 6. MONITORING TOOL
   New script: monitor_pipeline.sh
   
   Usage:
   ./monitor_pipeline.sh
   
   Features:
   - Color-coded log output (green=success, red=error, yellow=warning)
   - Follows pipeline log in real-time
   - Automatic detection of latest log file

## FILES MODIFIED

1. dsi_studio_pipeline.py
   - Added validate_fib_file() method
   - Added print_progress_summary() method
   - Enhanced main run() loop with progress tracking
   - Added comprehensive final summary
   - Updated FIB reconstruction to validate outputs
   - Improved progress reporting at each step

## FILES CREATED

1. PIPELINE_ENHANCEMENTS.md
   - Detailed documentation of all new features
   - Usage examples
   - Performance notes

2. monitor_pipeline.sh
   - Real-time pipeline monitoring script
   - Color-coded log output
   - Automatic log file detection

## USAGE EXAMPLES

### Run pipeline with all enhancements:
python dsi_studio_pipeline.py \
  --qsiprep_dir /data/local/129_PK01/derivatives/qsiprep \
  --output_dir /data/local/129_PK01/derivatives/dsistudio_connectomics \
  --require_mask \
  --skip_existing \
  --verify_rawdata \
  --dsi_studio_path /data/local/software/dsi-studio/ \
  --run_connectivity \
  --connectivity_config /data/local/software/dsistuido/graph_analysis_config.json

### Monitor in separate terminal:
./monitor_pipeline.sh

### Regenerate missing files after incomplete run:
python dsi_studio_pipeline.py ... --skip_existing

### Force regeneration of corrupted files:
python dsi_studio_pipeline.py ... --skip_existing --force

## EXPECTED OUTPUT

During processing, you'll see:

[10:00:00] Processing sub-1293171_ses-3_... [1/411]
[10:00:05] âœ“ SRC validated: sub-1293171_ses-3.src.gz.sz (245.3 MB)
[10:00:30] âœ“ FIB validated: sub-1293171_ses-3.odf.gqi.fz (62.45 MB, metrics: 8)
[10:00:31] 
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘ ğŸ“Š PIPELINE PROGRESS                                         â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘ Progress: [â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘] 0.2% (1/411)
â•‘ âœ“ Processed: 1  | âœ— Skipped: 0
â•‘ âœ“ SRC OK: 1  | âœ“ FIB OK: 1
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

[10:00:35] Processing sub-1293171_ses-2... [2/411]
...

At completion:

[12:30:00] 
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘ âœ“ PIPELINE COMPLETE                                          â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘ Total DWI files found:    411
â•‘ Successfully processed:   285
â•‘ SRC files validated:      285
â•‘ FIB files validated:      283
â•‘ Skipped (existing):        45
â•‘ Skipped (other reasons):   81
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

## BACKWARD COMPATIBILITY

âœ“ All enhancements are backward compatible
âœ“ Works with existing command-line flags
âœ“ No breaking changes to API or configuration
âœ“ Enhanced logging doesn't interfere with parsing

## NOTES

- Progress updates show iteration from PREVIOUS step
- Validation runs IMMEDIATELY after file generation
- Failed validations don't stop pipeline (logged as warnings)
- Final statistics are comprehensive and accurate
- Monitor script uses color coding for easy reading

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
EOF
